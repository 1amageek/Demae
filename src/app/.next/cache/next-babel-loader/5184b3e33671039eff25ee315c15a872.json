{"ast":null,"code":"import _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\n\nvar _s = $RefreshSig$(),\n    _s2 = $RefreshSig$(),\n    _jsxFileName = \"/Users/1amageek/Desktop/Demae/src/app/hooks/firestore/index.tsx\",\n    _s3 = $RefreshSig$(),\n    _s4 = $RefreshSig$();\n\nvar __jsx = React.createElement;\nimport React, { useEffect, useState, createContext, useContext } from 'react';\nimport \"firebase/firestore\";\nimport \"firebase/auth\";\nimport { firestore } from '@1amageek/ballcap';\nexport var useDocumentListen = function useDocumentListen(type, documentReference) {\n  _s();\n\n  var waiting = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n  var {\n    0: state,\n    1: setState\n  } = useState({\n    loading: true\n  });\n  useEffect(() => {\n    var enabled = true;\n    var listener;\n\n    var listen = /*#__PURE__*/function () {\n      var _ref = _asyncToGenerator(function* (documentReference) {\n        if (listener) {\n          listener();\n        }\n\n        listener = documentReference.onSnapshot({\n          next: snapshot => {\n            if (snapshot.exists) {\n              var data = type.fromSnapshot(snapshot);\n\n              if (enabled) {\n                setState({\n                  data: data,\n                  loading: false,\n                  error: undefined\n                });\n              }\n            } else {\n              if (enabled) {\n                setState({\n                  data: undefined,\n                  loading: false,\n                  error: undefined\n                });\n              }\n            }\n          },\n          error: _error => {\n            if (enabled) {\n              setState({\n                data: undefined,\n                loading: false,\n                error: _error\n              });\n            }\n          }\n        });\n      });\n\n      return function listen(_x) {\n        return _ref.apply(this, arguments);\n      };\n    }();\n\n    if (!waiting) {\n      if (documentReference) {\n        if (enabled) {\n          if (!state.loading) {\n            setState({\n              data: undefined,\n              loading: true,\n              error: undefined\n            });\n          }\n        }\n\n        if (listener) {\n          listener();\n        }\n\n        listen(documentReference);\n      } else {\n        if (enabled) {\n          setState({\n            data: undefined,\n            loading: false,\n            error: undefined\n          });\n        }\n      }\n    } else {\n      if (enabled) {\n        setState({\n          data: undefined,\n          loading: waiting,\n          error: undefined\n        });\n      }\n    }\n\n    return () => {\n      enabled = false;\n\n      if (listener) {\n        listener();\n      }\n    };\n  }, [documentReference === null || documentReference === void 0 ? void 0 : documentReference.path, waiting]);\n  return [state.data, state.loading, state.error];\n};\n\n_s(useDocumentListen, \"8gpkCwuelJ9NGSV9NiszyzlC59k=\");\n\nexport var Where = (fieldPath, opStr, value) => {\n  return {\n    fieldPath,\n    opStr,\n    value\n  };\n};\n_c = Where;\nexport var OrderBy = (fieldPath, directionStr) => {\n  return {\n    fieldPath,\n    directionStr\n  };\n};\n_c2 = OrderBy;\nexport var useDataSourceListen = function useDataSourceListen(type, query) {\n  _s2();\n\n  var waiting = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n  var {\n    0: state,\n    1: setState\n  } = useState({\n    data: [],\n    loading: true\n  });\n  var ref = query && query.path ? firestore.collection(query.path) : undefined;\n\n  if (query === null || query === void 0 ? void 0 : query.wheres) {\n    query.wheres.forEach(where => {\n      if (where) {\n        var _ref2;\n\n        var {\n          fieldPath,\n          opStr,\n          value\n        } = where;\n        ref = (_ref2 = ref) === null || _ref2 === void 0 ? void 0 : _ref2.where(fieldPath, opStr, value);\n      }\n    });\n  }\n\n  if (query === null || query === void 0 ? void 0 : query.orderBy) {\n    var _ref3;\n\n    var {\n      fieldPath,\n      directionStr\n    } = query.orderBy;\n    ref = (_ref3 = ref) === null || _ref3 === void 0 ? void 0 : _ref3.orderBy(fieldPath, directionStr);\n  }\n\n  if (query === null || query === void 0 ? void 0 : query.startAfter) {\n    var _ref4;\n\n    ref = (_ref4 = ref) === null || _ref4 === void 0 ? void 0 : _ref4.startAfter(query.startAfter);\n  }\n\n  if (query === null || query === void 0 ? void 0 : query.endBefore) {\n    var _ref5;\n\n    ref = (_ref5 = ref) === null || _ref5 === void 0 ? void 0 : _ref5.endBefore(query.endBefore);\n  }\n\n  if (query === null || query === void 0 ? void 0 : query.limit) {\n    var _ref6;\n\n    ref = (_ref6 = ref) === null || _ref6 === void 0 ? void 0 : _ref6.limit(query.limit);\n  }\n\n  useEffect(() => {\n    var enabled = true;\n    var listener;\n\n    var listen = /*#__PURE__*/function () {\n      var _ref7 = _asyncToGenerator(function* () {\n        var _ref8;\n\n        listener = (_ref8 = ref) === null || _ref8 === void 0 ? void 0 : _ref8.onSnapshot({\n          next: snapshot => {\n            var data = snapshot.docs.map(doc => type.fromSnapshot(doc));\n\n            if (enabled) {\n              setState({\n                data,\n                loading: false,\n                error: undefined\n              });\n            }\n          },\n          error: _error2 => {\n            console.error(_error2);\n\n            if (enabled) {\n              setState({\n                data: [],\n                loading: false,\n                error: _error2\n              });\n            }\n          }\n        });\n      });\n\n      return function listen() {\n        return _ref7.apply(this, arguments);\n      };\n    }();\n\n    if (!waiting) {\n      if (ref) {\n        listen();\n      } else {\n        setState({\n          data: [],\n          loading: false,\n          error: undefined\n        });\n      }\n    } else {\n      setState({\n        data: [],\n        loading: waiting,\n        error: undefined\n      });\n    }\n\n    return () => {\n      enabled = false;\n\n      if (listener) {\n        listener();\n      }\n    };\n  }, [query === null || query === void 0 ? void 0 : query.path, JSON.stringify(query === null || query === void 0 ? void 0 : query.wheres), JSON.stringify(query === null || query === void 0 ? void 0 : query.orderBy), query === null || query === void 0 ? void 0 : query.limit, waiting]);\n  return [state.data, state.loading, state.error];\n};\n\n_s2(useDataSourceListen, \"8byLdVI8jwdourZX63WHEkpoXLw=\");\n\nexport var QueryContext = createContext([{}, () => {}]);\nexport var QueryProvider = (_ref9) => {\n  _s3();\n\n  var {\n    children\n  } = _ref9;\n  var {\n    0: query,\n    1: setQuery\n  } = useState({});\n  return __jsx(QueryContext.Provider, {\n    value: [query, setQuery],\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 179,\n      columnNumber: 12\n    }\n  }, \" \", children, \" \");\n};\n\n_s3(QueryProvider, \"38FOMXVa0nLr3b/apkVA1yvhK8Y=\");\n\n_c3 = QueryProvider;\nexport var useQuery = init => {\n  _s4();\n\n  var {\n    0: query,\n    1: setQuery\n  } = useContext(QueryContext);\n  useEffect(() => {\n    if (init) {\n      setQuery(init);\n    }\n  }, []);\n  return [query, setQuery];\n};\n\n_s4(useQuery, \"MaDdOtmIf//15rE5KSOCw6z03mM=\");\n\nvar _c, _c2, _c3;\n\n$RefreshReg$(_c, \"Where\");\n$RefreshReg$(_c2, \"OrderBy\");\n$RefreshReg$(_c3, \"QueryProvider\");","map":{"version":3,"sources":["/Users/1amageek/Desktop/Demae/src/app/hooks/firestore/index.tsx"],"names":[],"mappings":"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","sourcesContent":["import React, { useEffect, useState, createContext, useContext } from 'react'\r\nimport firebase from \"firebase\"\r\nimport \"firebase/firestore\"\r\nimport \"firebase/auth\"\r\nimport { firestore, Doc, DocumentReference } from '@1amageek/ballcap'\r\n\r\nexport const useDocumentListen = <T extends Doc>(type: typeof Doc, documentReference?: DocumentReference, waiting: boolean = false): [T | undefined, boolean, Error?] => {\r\n\tinterface Prop {\r\n\t\tdata?: T\r\n\t\tloading: boolean\r\n\t\terror?: Error\r\n\t}\r\n\tconst [state, setState] = useState<Prop>({ loading: true })\r\n\tuseEffect(() => {\r\n\t\tlet enabled = true\r\n\t\tlet listener: (() => void) | undefined\r\n\t\tconst listen = async (documentReference: DocumentReference) => {\r\n\t\t\tif (listener) {\r\n\t\t\t\tlistener()\r\n\t\t\t}\r\n\t\t\tlistener = documentReference.onSnapshot({\r\n\t\t\t\tnext: (snapshot) => {\r\n\t\t\t\t\tif (snapshot.exists) {\r\n\t\t\t\t\t\tconst data = type.fromSnapshot<T>(snapshot)\r\n\t\t\t\t\t\tif (enabled) {\r\n\t\t\t\t\t\t\tsetState({\r\n\t\t\t\t\t\t\t\tdata: data,\r\n\t\t\t\t\t\t\t\tloading: false,\r\n\t\t\t\t\t\t\t\terror: undefined\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tif (enabled) {\r\n\t\t\t\t\t\t\tsetState({\r\n\t\t\t\t\t\t\t\tdata: undefined,\r\n\t\t\t\t\t\t\t\tloading: false,\r\n\t\t\t\t\t\t\t\terror: undefined\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\terror: (error) => {\r\n\t\t\t\t\tif (enabled) {\r\n\t\t\t\t\t\tsetState({\r\n\t\t\t\t\t\t\tdata: undefined,\r\n\t\t\t\t\t\t\tloading: false,\r\n\t\t\t\t\t\t\terror\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t}\r\n\t\tif (!waiting) {\r\n\t\t\tif (documentReference) {\r\n\t\t\t\tif (enabled) {\r\n\t\t\t\t\tif (!state.loading) {\r\n\t\t\t\t\t\tsetState({\r\n\t\t\t\t\t\t\tdata: undefined,\r\n\t\t\t\t\t\t\tloading: true,\r\n\t\t\t\t\t\t\terror: undefined\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (listener) {\r\n\t\t\t\t\tlistener()\r\n\t\t\t\t}\r\n\t\t\t\tlisten(documentReference)\r\n\t\t\t} else {\r\n\t\t\t\tif (enabled) {\r\n\t\t\t\t\tsetState({\r\n\t\t\t\t\t\tdata: undefined,\r\n\t\t\t\t\t\tloading: false,\r\n\t\t\t\t\t\terror: undefined\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tif (enabled) {\r\n\t\t\t\tsetState({\r\n\t\t\t\t\tdata: undefined,\r\n\t\t\t\t\tloading: waiting,\r\n\t\t\t\t\terror: undefined\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn () => {\r\n\t\t\tenabled = false\r\n\t\t\tif (listener) {\r\n\t\t\t\tlistener()\r\n\t\t\t}\r\n\t\t}\r\n\t}, [documentReference?.path, waiting])\r\n\treturn [state.data, state.loading, state.error]\r\n}\r\n\r\nexport interface WhereQuery {\r\n\tfieldPath: string | firebase.firestore.FieldPath\r\n\topStr: firebase.firestore.WhereFilterOp\r\n\tvalue: any\r\n}\r\n\r\nexport interface OrderByQuery {\r\n\tfieldPath: string | firebase.firestore.FieldPath,\r\n\tdirectionStr?: firebase.firestore.OrderByDirection\r\n}\r\n\r\nexport const Where = (fieldPath: string | firebase.firestore.FieldPath,\r\n\topStr: firebase.firestore.WhereFilterOp,\r\n\tvalue: any): WhereQuery => {\r\n\treturn { fieldPath, opStr, value }\r\n}\r\n\r\nexport const OrderBy = (fieldPath: string | firebase.firestore.FieldPath,\r\n\tdirectionStr?: firebase.firestore.OrderByDirection): OrderByQuery => {\r\n\treturn { fieldPath, directionStr }\r\n}\r\n\r\nexport interface Query {\r\n\tpath?: string\r\n\twheres?: Array<WhereQuery | undefined>\r\n\torderBy?: OrderByQuery\r\n\tlimit?: number\r\n\tstartAfter?: firebase.firestore.DocumentSnapshot<any>\r\n\tendBefore?: firebase.firestore.DocumentSnapshot<any>\r\n}\r\n\r\nexport const useDataSourceListen = <T extends Doc>(type: typeof Doc, query?: Query, waiting: boolean = false): [T[], boolean, Error | undefined] => {\r\n\tinterface Prop {\r\n\t\tdata: T[]\r\n\t\tloading: boolean\r\n\t\terror?: Error\r\n\t}\r\n\tconst [state, setState] = useState<Prop>({ data: [], loading: true })\r\n\tlet ref: firebase.firestore.Query | undefined = (query && query.path) ? firestore.collection(query.path) : undefined\r\n\r\n\tif (query?.wheres) {\r\n\t\tquery.wheres.forEach(where => {\r\n\t\t\tif (where) {\r\n\t\t\t\tconst { fieldPath, opStr, value } = where\r\n\t\t\t\tref = ref?.where(fieldPath, opStr, value)\r\n\t\t\t}\r\n\t\t})\r\n\t}\r\n\r\n\tif (query?.orderBy) {\r\n\t\tconst { fieldPath, directionStr } = query.orderBy\r\n\t\tref = ref?.orderBy(fieldPath, directionStr)\r\n\t}\r\n\r\n\tif (query?.startAfter) {\r\n\t\tref = ref?.startAfter(query.startAfter)\r\n\t}\r\n\r\n\tif (query?.endBefore) {\r\n\t\tref = ref?.endBefore(query.endBefore)\r\n\t}\r\n\r\n\tif (query?.limit) {\r\n\t\tref = ref?.limit(query.limit)\r\n\t}\r\n\r\n\tuseEffect(() => {\r\n\t\tlet enabled = true\r\n\t\tlet listener: (() => void) | undefined\r\n\t\tconst listen = async () => {\r\n\t\t\tlistener = ref?.onSnapshot({\r\n\t\t\t\tnext: (snapshot) => {\r\n\t\t\t\t\tconst data = snapshot.docs.map(doc => type.fromSnapshot<T>(doc))\r\n\t\t\t\t\tif (enabled) {\r\n\t\t\t\t\t\tsetState({\r\n\t\t\t\t\t\t\tdata,\r\n\t\t\t\t\t\t\tloading: false,\r\n\t\t\t\t\t\t\terror: undefined\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\terror: (error) => {\r\n\t\t\t\t\tconsole.error(error)\r\n\t\t\t\t\tif (enabled) {\r\n\t\t\t\t\t\tsetState({\r\n\t\t\t\t\t\t\tdata: [],\r\n\t\t\t\t\t\t\tloading: false,\r\n\t\t\t\t\t\t\terror\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t};\r\n\r\n\t\tif (!waiting) {\r\n\t\t\tif (ref) {\r\n\t\t\t\tlisten()\r\n\t\t\t} else {\r\n\t\t\t\tsetState({\r\n\t\t\t\t\tdata: [],\r\n\t\t\t\t\tloading: false,\r\n\t\t\t\t\terror: undefined\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tsetState({\r\n\t\t\t\tdata: [],\r\n\t\t\t\tloading: waiting,\r\n\t\t\t\terror: undefined\r\n\t\t\t})\r\n\t\t}\r\n\t\treturn () => {\r\n\t\t\tenabled = false\r\n\t\t\tif (listener) {\r\n\t\t\t\tlistener()\r\n\t\t\t}\r\n\t\t}\r\n\t}, [query?.path, JSON.stringify(query?.wheres), JSON.stringify(query?.orderBy), query?.limit, waiting])\r\n\treturn [state.data, state.loading, state.error]\r\n};\r\n\r\n\r\nexport const QueryContext = createContext<[Query, React.Dispatch<React.SetStateAction<Query>>]>([{}, () => { }])\r\nexport const QueryProvider = ({ children }: { children: any }) => {\r\n\tconst [query, setQuery] = useState<Query>({})\r\n\treturn <QueryContext.Provider value={[query, setQuery]}> {children} </QueryContext.Provider>\r\n}\r\n\r\nexport const useQuery = (init?: Query): [Query, React.Dispatch<React.SetStateAction<Query>>] => {\r\n\tconst [query, setQuery] = useContext(QueryContext)\r\n\tuseEffect(() => {\r\n\t\tif (init) {\r\n\t\t\tsetQuery(init)\r\n\t\t}\r\n\t}, [])\r\n\treturn [query, setQuery]\r\n}\r\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}