{"ast":null,"code":"import _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\n\nvar _jsxFileName = \"/Users/1amageek/Desktop/Demae/src/app/components/checkout/payment/list.tsx\",\n    _s = $RefreshSig$(),\n    _s2 = $RefreshSig$();\n\nvar __jsx = React.createElement;\nimport React, { useContext, useState } from 'react';\nimport { createStyles, makeStyles } from '@material-ui/core/styles';\nimport firebase from 'firebase';\nimport { loadStripe } from '@stripe/stripe-js';\nimport { CardElement, Elements, useStripe, useElements } from '@stripe/react-stripe-js';\nimport 'firebase/functions';\nimport ArrowBackIcon from '@material-ui/icons/ArrowBack';\nimport { Paper, AppBar, Toolbar, Button, Typography, Tooltip, IconButton, FormControlLabel, Checkbox } from '@material-ui/core';\nimport { List, ListItem, ListItemText, ListItemIcon } from '@material-ui/core';\nimport AddIcon from '@material-ui/icons/Add';\nimport Loading from 'components/Loading';\nimport { ExpansionPanel, ExpansionPanelSummary, ExpansionPanelDetails, ExpansionPanelActions, Divider, Box } from '@material-ui/core';\nimport ExpandMoreIcon from '@material-ui/icons/ExpandMore';\nimport CardBrand from 'common/stripe/CardBrand';\nimport * as Commerce from 'models/commerce';\nimport DataLoading from 'components/DataLoading';\nimport { useDialog } from 'components/Dialog';\nimport { useFetchList } from 'hooks/stripe';\nimport { useAuthUser } from 'hooks/auth';\nimport { UserContext } from 'hooks/commerce';\nimport { useProcessing } from 'components/Processing';\nimport { usePush, usePop } from 'components/Navigation';\nimport { useSnackbar } from 'components/Snackbar';\nexport default _s((_ref) => {\n  _s();\n\n  var {\n    user\n  } = _ref;\n  var [setProcessing] = useProcessing();\n  var [paymentMethods, isLoading, error, setPaymentMethods] = useFetchList('v1-stripe-paymentMethod-list', {\n    type: 'card'\n  });\n  var [setMessage] = useSnackbar();\n  var [setDialog, close] = useDialog();\n  var [push] = usePush();\n  var pop = usePop();\n\n  if (error) {\n    console.error(error);\n  }\n\n  var setDefaultPaymentMethod = /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator(function* (paymentMethod) {\n      setProcessing(true);\n      var customerUpdate = firebase.functions().httpsCallable('v1-stripe-customer-update');\n\n      try {\n        var response = yield customerUpdate({\n          // payment_method: paymentMethod.id,\n          invoice_settings: {\n            default_payment_method: paymentMethod.id\n          }\n        });\n        var {\n          result,\n          error: _error\n        } = response.data;\n\n        if (_error) {\n          console.error(_error);\n          setProcessing(false);\n          setMessage('error', _error.message);\n          return;\n        }\n\n        var card = new Commerce.Card(paymentMethod.id);\n        card.brand = paymentMethod.card.brand;\n        card.expMonth = paymentMethod.card.exp_month;\n        card.expYear = paymentMethod.card.exp_year;\n        card.last4 = paymentMethod.card.last4;\n        yield user.documentReference.set({\n          defaultCard: card.convert()\n        }, {\n          merge: true\n        });\n        console.log('[APP] set default payment method', result);\n      } catch (error) {\n        console.error(error);\n      }\n\n      setProcessing(false);\n      pop();\n    });\n\n    return function setDefaultPaymentMethod(_x) {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n\n  var paymentMethodDetach = /*#__PURE__*/function () {\n    var _ref3 = _asyncToGenerator(function* (deletePaymentMethod) {\n      if (!deletePaymentMethod) {\n        return;\n      }\n\n      setProcessing(true);\n\n      try {\n        var _user$defaultCard;\n\n        var detach = firebase.functions().httpsCallable('v1-stripe-paymentMethod-detach');\n        var response = yield detach({\n          paymentMethodID: deletePaymentMethod.id\n        });\n        var {\n          result,\n          error: _error2\n        } = response.data;\n\n        if (_error2) {\n          console.error(_error2);\n          setProcessing(false);\n          setMessage('error', _error2.message);\n          return;\n        }\n\n        console.log('[APP] detach payment method', result);\n        var data = paymentMethods.filter(method => method.id !== deletePaymentMethod.id);\n\n        if (deletePaymentMethod.id === ((_user$defaultCard = user.defaultCard) === null || _user$defaultCard === void 0 ? void 0 : _user$defaultCard.id)) {\n          if (data.length > 0) {\n            var method = data[0];\n            yield setDefaultPaymentMethod(method);\n          } else {\n            yield user.documentReference.set({\n              defaultCard: null\n            }, {\n              merge: true\n            });\n          }\n        }\n\n        setPaymentMethods(data);\n      } catch (error) {\n        console.error(error);\n      }\n\n      setProcessing(false);\n    });\n\n    return function paymentMethodDetach(_x2) {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n\n  if (isLoading) {\n    return __jsx(Paper, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 105,\n        columnNumber: 17\n      }\n    }, __jsx(DataLoading, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 106,\n        columnNumber: 5\n      }\n    }));\n  }\n\n  return __jsx(Paper, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 109,\n      columnNumber: 13\n    }\n  }, __jsx(AppBar, {\n    position: \"static\",\n    color: \"transparent\",\n    elevation: 0,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 110,\n      columnNumber: 4\n    }\n  }, __jsx(Toolbar, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 111,\n      columnNumber: 5\n    }\n  }, __jsx(Tooltip, {\n    title: \"Back\",\n    onClick: () => {\n      pop();\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 112,\n      columnNumber: 6\n    }\n  }, __jsx(IconButton, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 115,\n      columnNumber: 7\n    }\n  }, __jsx(ArrowBackIcon, {\n    color: \"inherit\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 116,\n      columnNumber: 8\n    }\n  }))), __jsx(Box, {\n    fontSize: 18,\n    fontWeight: 600,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 119,\n      columnNumber: 6\n    }\n  }, \"Card\"))), paymentMethods.map(method => {\n    var _user$defaultCard2, _method$card, _method$card2, _method$card3;\n\n    return __jsx(ExpansionPanel, {\n      key: method.id,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 125,\n        columnNumber: 17\n      }\n    }, __jsx(ExpansionPanelSummary, {\n      expandIcon: __jsx(ExpandMoreIcon, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 126,\n          columnNumber: 43\n        }\n      }),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 126,\n        columnNumber: 8\n      }\n    }, __jsx(FormControlLabel, {\n      onClick: /*#__PURE__*/function () {\n        var _ref4 = _asyncToGenerator(function* (event) {\n          event.stopPropagation();\n          yield setDefaultPaymentMethod(method);\n        });\n\n        return function (_x3) {\n          return _ref4.apply(this, arguments);\n        };\n      }(),\n      onFocus: event => event.stopPropagation(),\n      control: __jsx(Checkbox, {\n        checked: ((_user$defaultCard2 = user.defaultCard) === null || _user$defaultCard2 === void 0 ? void 0 : _user$defaultCard2.id) === method.id,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 130,\n          columnNumber: 66\n        }\n      }),\n      label: __jsx(Box, {\n        display: \"flex\",\n        alignItems: \"center\",\n        flexGrow: 1,\n        style: {\n          width: '140px'\n        },\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 130,\n          columnNumber: 131\n        }\n      }, __jsx(Box, {\n        display: \"flex\",\n        alignItems: \"center\",\n        flexGrow: 1,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 131,\n          columnNumber: 12\n        }\n      }, __jsx(\"i\", {\n        className: \"pf \".concat(CardBrand[method.card.brand]),\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 132,\n          columnNumber: 13\n        }\n      })), __jsx(Box, {\n        justifySelf: \"flex-end\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 134,\n          columnNumber: 12\n        }\n      }, \"\\u2022 \\u2022 \\u2022 \\u2022  \".concat((_method$card = method.card) === null || _method$card === void 0 ? void 0 : _method$card.last4))),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 127,\n        columnNumber: 9\n      }\n    })), __jsx(ExpansionPanelDetails, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 139,\n        columnNumber: 8\n      }\n    }, __jsx(Typography, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 140,\n        columnNumber: 9\n      }\n    }, \"expire \", \"\".concat((_method$card2 = method.card) === null || _method$card2 === void 0 ? void 0 : _method$card2.exp_year, \"/\").concat((_method$card3 = method.card) === null || _method$card3 === void 0 ? void 0 : _method$card3.exp_month))), __jsx(Divider, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 144,\n        columnNumber: 8\n      }\n    }), __jsx(ExpansionPanelActions, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 145,\n        columnNumber: 8\n      }\n    }, __jsx(Button, {\n      size: \"small\",\n      onClick: /*#__PURE__*/_asyncToGenerator(function* () {\n        setDialog('Delete', 'Do you want to remove it?', [{\n          title: 'Cancel',\n          handler: close\n        }, {\n          title: 'OK',\n          handler: function () {\n            var _handler = _asyncToGenerator(function* () {\n              yield paymentMethodDetach(method);\n            });\n\n            function handler() {\n              return _handler.apply(this, arguments);\n            }\n\n            return handler;\n          }()\n        }]);\n      }),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 146,\n        columnNumber: 9\n      }\n    }, \"Delete\")));\n  }), __jsx(List, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 163,\n      columnNumber: 4\n    }\n  }, __jsx(ListItem, {\n    button: true,\n    onClick: () => {\n      push(__jsx(CardInput, {\n        callback: paymentMethod => {\n          setPaymentMethods([...paymentMethods, paymentMethod]);\n        },\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 165,\n          columnNumber: 14\n        }\n      }));\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 164,\n      columnNumber: 5\n    }\n  }, __jsx(ListItemIcon, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 169,\n      columnNumber: 6\n    }\n  }, __jsx(AddIcon, {\n    color: \"secondary\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 170,\n      columnNumber: 7\n    }\n  })), __jsx(ListItemText, {\n    primary: \"Add new payment method\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 172,\n      columnNumber: 6\n    }\n  }))));\n}, \"oDqPyPczCwiKQkxaF5oZgg9Sxag=\", false, function () {\n  return [useProcessing, useFetchList, useSnackbar, useDialog, usePush, usePop];\n});\nvar STRIPE_API_KEY = process.env.STRIPE_API_KEY;\nvar stripePromise = loadStripe(STRIPE_API_KEY);\nvar CARD_OPTIONS = {\n  style: {\n    base: {\n      fontSize: '16px'\n    },\n    invalid: {\n      iconColor: '#FFC7EE',\n      color: '#FFC7EE'\n    }\n  },\n  hidePostalCode: true\n};\n\nvar CardInput = (_ref6) => {\n  var {\n    callback\n  } = _ref6;\n  return __jsx(Elements, {\n    stripe: stripePromise,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 192,\n      columnNumber: 13\n    }\n  }, __jsx(Form, {\n    callback: callback,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 193,\n      columnNumber: 4\n    }\n  }));\n};\n\n_c = CardInput;\nvar useStyles = makeStyles(theme => createStyles({\n  box: {\n    padding: theme.spacing(3)\n  },\n  button: {\n    width: '100%',\n    flexGrow: 1,\n    marginTop: theme.spacing(4)\n  }\n}));\n\nvar Form = (_ref7) => {\n  _s2();\n\n  var {\n    callback\n  } = _ref7;\n  var classes = useStyles();\n  var [auth] = useAuthUser();\n  var {\n    0: user,\n    1: isUserLoading\n  } = useContext(UserContext);\n  var stripe = useStripe();\n  var elements = useElements();\n  var {\n    0: isDisabled,\n    1: setDisable\n  } = useState(true);\n  var [setProcessing] = useProcessing();\n  var pop = usePop();\n\n  var handleSubmit = /*#__PURE__*/function () {\n    var _ref8 = _asyncToGenerator(function* (event) {\n      event.preventDefault();\n\n      if (!auth) {\n        return;\n      }\n\n      if (!stripe) {\n        return;\n      }\n\n      if (!elements) {\n        return;\n      }\n\n      var card = elements.getElement(CardElement);\n\n      if (!card) {\n        return;\n      }\n\n      setProcessing(true);\n\n      try {\n        var {\n          error,\n          paymentMethod\n        } = yield stripe.createPaymentMethod({\n          type: 'card',\n          card: card\n        });\n\n        if (error) {\n          console.log(error);\n          setProcessing(false);\n          return;\n        }\n\n        if (!paymentMethod) {\n          setProcessing(false);\n          return;\n        }\n\n        var cardMethod = new Commerce.Card(paymentMethod.id);\n        cardMethod.id = paymentMethod.id;\n        cardMethod.brand = paymentMethod.card.brand;\n        cardMethod.expMonth = paymentMethod.card.exp_month;\n        cardMethod.expYear = paymentMethod.card.exp_year;\n        cardMethod.last4 = paymentMethod.card.last4;\n        var updateData = {\n          defaultCard: cardMethod.convert()\n        };\n\n        if (user === null || user === void 0 ? void 0 : user.customerID) {\n          var attach = firebase.functions().httpsCallable('v1-stripe-paymentMethod-attach');\n          var response = yield attach({\n            paymentMethodID: paymentMethod.id\n          });\n          var {\n            error: _error3,\n            result\n          } = response.data;\n\n          if (_error3) {\n            console.error(_error3);\n            setProcessing(false);\n            return;\n          }\n\n          if (result) {\n            if (callback) {\n              callback(result);\n            }\n          }\n\n          console.log('[APP] attach payment method', result);\n        } else {\n          var create = firebase.functions().httpsCallable('v1-stripe-customer-create');\n\n          var _response = yield create({\n            payment_method: paymentMethod.id,\n            phone: auth.phoneNumber,\n            invoice_settings: {\n              default_payment_method: paymentMethod.id\n            },\n            metadata: {\n              uid: auth.uid\n            }\n          });\n\n          var {\n            error: _error4,\n            result: _result\n          } = _response.data;\n\n          if (_error4) {\n            console.error(_error4);\n            setProcessing(false);\n            return;\n          }\n\n          console.log('[APP] create customer', _result);\n\n          if (_result) {\n            var customerID = _result.id;\n            updateData['customerID'] = customerID;\n\n            if (callback) {\n              callback(_result);\n            }\n          }\n        }\n\n        yield new Commerce.User(auth.uid).documentReference.set(updateData, {\n          merge: true\n        });\n        setProcessing(false);\n        pop();\n      } catch (error) {\n        setProcessing(false);\n        console.log(error);\n      }\n    });\n\n    return function handleSubmit(_x4) {\n      return _ref8.apply(this, arguments);\n    };\n  }();\n\n  if (isUserLoading) {\n    return __jsx(Loading, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 309,\n        columnNumber: 16\n      }\n    });\n  } else {\n    return __jsx(Paper, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 312,\n        columnNumber: 17\n      }\n    }, __jsx(AppBar, {\n      position: \"static\",\n      color: \"transparent\",\n      elevation: 0,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 313,\n        columnNumber: 5\n      }\n    }, __jsx(Toolbar, {\n      disableGutters: true,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 314,\n        columnNumber: 6\n      }\n    }, __jsx(Tooltip, {\n      title: \"Back\",\n      onClick: () => {\n        pop();\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 315,\n        columnNumber: 7\n      }\n    }, __jsx(IconButton, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 318,\n        columnNumber: 8\n      }\n    }, __jsx(ArrowBackIcon, {\n      color: \"inherit\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 319,\n        columnNumber: 9\n      }\n    }))), __jsx(Box, {\n      fontSize: 18,\n      fontWeight: 600,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 322,\n        columnNumber: 7\n      }\n    }, \"Card\"))), __jsx(Box, {\n      p: 2,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 327,\n        columnNumber: 5\n      }\n    }, __jsx(\"form\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 328,\n        columnNumber: 6\n      }\n    }, __jsx(CardElement, {\n      options: CARD_OPTIONS,\n      onChange: e => {\n        setDisable(!e.complete);\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 329,\n        columnNumber: 7\n      }\n    }), __jsx(Button, {\n      className: classes.button,\n      variant: \"contained\",\n      color: \"primary\",\n      size: \"large\",\n      disabled: isDisabled,\n      onClick: handleSubmit,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 332,\n        columnNumber: 7\n      }\n    }, \"Continue to Payment\"))));\n  }\n};\n\n_s2(Form, \"bHMGmIEDxiwWTcPV0jWPVWD37PA=\", false, function () {\n  return [useStyles, useAuthUser, useStripe, useElements, useProcessing, usePop];\n});\n\n_c2 = Form;\n\nvar _c, _c2;\n\n$RefreshReg$(_c, \"CardInput\");\n$RefreshReg$(_c2, \"Form\");","map":{"version":3,"sources":["/Users/1amageek/Desktop/Demae/src/app/components/checkout/payment/list.tsx"],"names":[],"mappings":"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","sourcesContent":["import React, { useContext, useState } from 'react'\r\nimport { createStyles, Theme, makeStyles } from '@material-ui/core/styles'\r\nimport firebase from 'firebase'\r\nimport { loadStripe } from '@stripe/stripe-js'\r\nimport {\r\n\tCardElement,\r\n\tElements,\r\n\tuseStripe,\r\n\tuseElements,\r\n} from '@stripe/react-stripe-js'\r\nimport 'firebase/functions'\r\nimport ArrowBackIcon from '@material-ui/icons/ArrowBack';\r\nimport { Paper, AppBar, Toolbar, Button, Typography, Tooltip, IconButton, FormControlLabel, Checkbox, Card } from '@material-ui/core'\r\nimport { List, ListItem, ListItemText, ListItemIcon } from '@material-ui/core';\r\nimport AddIcon from '@material-ui/icons/Add';\r\nimport Loading from 'components/Loading'\r\nimport { Container, ExpansionPanel, ExpansionPanelSummary, ExpansionPanelDetails, ExpansionPanelActions, Divider, Box } from '@material-ui/core';\r\nimport ExpandMoreIcon from '@material-ui/icons/ExpandMore';\r\nimport CardBrand from 'common/stripe/CardBrand'\r\nimport * as Commerce from 'models/commerce'\r\nimport { PaymentMethod } from '@stripe/stripe-js'\r\nimport DataLoading from 'components/DataLoading';\r\nimport { useDialog } from 'components/Dialog'\r\nimport { useFetchList } from 'hooks/stripe'\r\nimport { useAuthUser } from 'hooks/auth'\r\nimport { UserContext } from 'hooks/commerce'\r\nimport { useProcessing } from 'components/Processing';\r\nimport { usePush, usePop } from 'components/Navigation';\r\nimport { useSnackbar } from 'components/Snackbar'\r\n\r\nexport default ({ user }: { user: Commerce.User }) => {\r\n\r\n\tconst [setProcessing] = useProcessing()\r\n\tconst [paymentMethods, isLoading, error, setPaymentMethods] = useFetchList<PaymentMethod>('v1-stripe-paymentMethod-list', { type: 'card' })\r\n\tconst [setMessage] = useSnackbar()\r\n\tconst [setDialog, close] = useDialog()\r\n\tconst [push] = usePush()\r\n\tconst pop = usePop()\r\n\r\n\tif (error) {\r\n\t\tconsole.error(error)\r\n\t}\r\n\r\n\tconst setDefaultPaymentMethod = async (paymentMethod: PaymentMethod) => {\r\n\t\tsetProcessing(true)\r\n\t\tconst customerUpdate = firebase.functions().httpsCallable('v1-stripe-customer-update')\r\n\t\ttry {\r\n\t\t\tconst response = await customerUpdate({\r\n\t\t\t\t// payment_method: paymentMethod.id,\r\n\t\t\t\tinvoice_settings: {\r\n\t\t\t\t\tdefault_payment_method: paymentMethod.id\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t\tconst { result, error } = response.data\r\n\t\t\tif (error) {\r\n\t\t\t\tconsole.error(error)\r\n\t\t\t\tsetProcessing(false)\r\n\t\t\t\tsetMessage('error', error.message)\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\t\t\tconst card = new Commerce.Card(paymentMethod.id)\r\n\t\t\tcard.brand = paymentMethod.card!.brand\r\n\t\t\tcard.expMonth = paymentMethod.card!.exp_month\r\n\t\t\tcard.expYear = paymentMethod.card!.exp_year\r\n\t\t\tcard.last4 = paymentMethod.card!.last4\r\n\t\t\tawait user.documentReference.set({\r\n\t\t\t\tdefaultCard: card.convert()\r\n\t\t\t}, { merge: true })\r\n\t\t\tconsole.log('[APP] set default payment method', result)\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(error)\r\n\t\t}\r\n\t\tsetProcessing(false)\r\n\t\tpop()\r\n\t}\r\n\r\n\tconst paymentMethodDetach = async (deletePaymentMethod: PaymentMethod) => {\r\n\t\tif (!deletePaymentMethod) {\r\n\t\t\treturn\r\n\t\t}\r\n\t\tsetProcessing(true)\r\n\t\ttry {\r\n\t\t\tconst detach = firebase.functions().httpsCallable('v1-stripe-paymentMethod-detach')\r\n\t\t\tconst response = await detach({\r\n\t\t\t\tpaymentMethodID: deletePaymentMethod.id\r\n\t\t\t})\r\n\t\t\tconst { result, error } = response.data\r\n\t\t\tif (error) {\r\n\t\t\t\tconsole.error(error)\r\n\t\t\t\tsetProcessing(false)\r\n\t\t\t\tsetMessage('error', error.message)\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\t\t\tconsole.log('[APP] detach payment method', result)\r\n\t\t\tconst data = paymentMethods.filter(method => method.id !== deletePaymentMethod.id)\r\n\t\t\tif (deletePaymentMethod.id === user.defaultCard?.id) {\r\n\t\t\t\tif (data.length > 0) {\r\n\t\t\t\t\tconst method = data[0]\r\n\t\t\t\t\tawait setDefaultPaymentMethod(method)\r\n\t\t\t\t} else {\r\n\t\t\t\t\tawait user.documentReference.set({\r\n\t\t\t\t\t\tdefaultCard: null\r\n\t\t\t\t\t}, { merge: true })\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tsetPaymentMethods(data)\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(error)\r\n\t\t}\r\n\t\tsetProcessing(false)\r\n\t}\r\n\r\n\tif (isLoading) {\r\n\t\treturn (\r\n\t\t\t<Paper>\r\n\t\t\t\t<DataLoading />\r\n\t\t\t</Paper>\r\n\t\t)\r\n\t}\r\n\r\n\treturn (\r\n\t\t<Paper>\r\n\t\t\t<AppBar position='static' color='transparent' elevation={0}>\r\n\t\t\t\t<Toolbar>\r\n\t\t\t\t\t<Tooltip title='Back' onClick={() => {\r\n\t\t\t\t\t\tpop()\r\n\t\t\t\t\t}}>\r\n\t\t\t\t\t\t<IconButton>\r\n\t\t\t\t\t\t\t<ArrowBackIcon color='inherit' />\r\n\t\t\t\t\t\t</IconButton>\r\n\t\t\t\t\t</Tooltip>\r\n\t\t\t\t\t<Box fontSize={18} fontWeight={600}>\r\n\t\t\t\t\t\tCard\r\n\t\t\t\t\t</Box>\r\n\t\t\t\t</Toolbar>\r\n\t\t\t</AppBar>\r\n\t\t\t{\r\n\t\t\t\tpaymentMethods.map(method => {\r\n\t\t\t\t\treturn (\r\n\t\t\t\t\t\t<ExpansionPanel key={method.id} >\r\n\t\t\t\t\t\t\t<ExpansionPanelSummary expandIcon={<ExpandMoreIcon />}>\r\n\t\t\t\t\t\t\t\t<FormControlLabel\r\n\t\t\t\t\t\t\t\t\tonClick={async (event) => {\r\n\t\t\t\t\t\t\t\t\t\tevent.stopPropagation()\r\n\t\t\t\t\t\t\t\t\t\tawait setDefaultPaymentMethod(method)\r\n\t\t\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t\t\t\tonFocus={(event) => event.stopPropagation()}\r\n\t\t\t\t\t\t\t\t\tcontrol={<Checkbox checked={user.defaultCard?.id === method.id} />}\r\n\t\t\t\t\t\t\t\t\tlabel={\r\n\t\t\t\t\t\t\t\t\t\t<Box display=\"flex\" alignItems=\"center\" flexGrow={1} style={{ width: '140px' }}>\r\n\t\t\t\t\t\t\t\t\t\t\t<Box display=\"flex\" alignItems=\"center\" flexGrow={1}>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<i className={`pf ${CardBrand[method.card!.brand]}`}></i>\r\n\t\t\t\t\t\t\t\t\t\t\t</Box>\r\n\t\t\t\t\t\t\t\t\t\t\t<Box justifySelf=\"flex-end\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t{`• • • •  ${method.card?.last4}`}\r\n\t\t\t\t\t\t\t\t\t\t\t</Box>\r\n\t\t\t\t\t\t\t\t\t\t</Box>\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t</ExpansionPanelSummary>\r\n\t\t\t\t\t\t\t<ExpansionPanelDetails>\r\n\t\t\t\t\t\t\t\t<Typography>\r\n\t\t\t\t\t\t\t\t\texpire {`${method.card?.exp_year}/${method.card?.exp_month}`}\r\n\t\t\t\t\t\t\t\t</Typography>\r\n\t\t\t\t\t\t\t</ExpansionPanelDetails>\r\n\t\t\t\t\t\t\t<Divider />\r\n\t\t\t\t\t\t\t<ExpansionPanelActions>\r\n\t\t\t\t\t\t\t\t<Button size=\"small\" onClick={async () => {\r\n\t\t\t\t\t\t\t\t\tsetDialog('Delete', 'Do you want to remove it?', [\r\n\t\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\t\ttitle: 'Cancel',\r\n\t\t\t\t\t\t\t\t\t\t\thandler: close\r\n\t\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\t\ttitle: 'OK',\r\n\t\t\t\t\t\t\t\t\t\t\thandler: async () => {\r\n\t\t\t\t\t\t\t\t\t\t\t\tawait paymentMethodDetach(method)\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t}])\r\n\t\t\t\t\t\t\t\t}}>Delete</Button>\r\n\t\t\t\t\t\t\t</ExpansionPanelActions>\r\n\t\t\t\t\t\t</ExpansionPanel>\r\n\t\t\t\t\t)\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t\t<List>\r\n\t\t\t\t<ListItem button onClick={() => {\r\n\t\t\t\t\tpush(<CardInput callback={(paymentMethod) => {\r\n\t\t\t\t\t\tsetPaymentMethods([...paymentMethods, paymentMethod])\r\n\t\t\t\t\t}} />)\r\n\t\t\t\t}}>\r\n\t\t\t\t\t<ListItemIcon>\r\n\t\t\t\t\t\t<AddIcon color=\"secondary\" />\r\n\t\t\t\t\t</ListItemIcon>\r\n\t\t\t\t\t<ListItemText primary={`Add new payment method`} />\r\n\t\t\t\t</ListItem>\r\n\t\t\t</List>\r\n\t\t</Paper>\r\n\t)\r\n}\r\n\r\nconst STRIPE_API_KEY = process.env.STRIPE_API_KEY!\r\nconst stripePromise = loadStripe(STRIPE_API_KEY)\r\n\r\nconst CARD_OPTIONS = {\r\n\tstyle: {\r\n\t\tbase: {\r\n\t\t\tfontSize: '16px',\r\n\t\t},\r\n\t\tinvalid: {\r\n\t\t\ticonColor: '#FFC7EE',\r\n\t\t\tcolor: '#FFC7EE',\r\n\t\t},\r\n\t},\r\n\thidePostalCode: true\r\n};\r\n\r\nconst CardInput = ({ callback }: { callback?: (paymentMethod: PaymentMethod) => void }) => {\r\n\treturn (\r\n\t\t<Elements stripe={stripePromise}>\r\n\t\t\t<Form callback={callback} />\r\n\t\t</Elements>\r\n\t)\r\n}\r\n\r\nconst useStyles = makeStyles((theme: Theme) =>\r\n\tcreateStyles({\r\n\t\tbox: {\r\n\t\t\tpadding: theme.spacing(3),\r\n\t\t},\r\n\t\tbutton: {\r\n\t\t\twidth: '100%',\r\n\t\t\tflexGrow: 1,\r\n\t\t\tmarginTop: theme.spacing(4)\r\n\t\t}\r\n\t}),\r\n);\r\n\r\nconst Form = ({ callback }: { callback?: (paymentMethod: PaymentMethod) => void }) => {\r\n\tconst classes = useStyles()\r\n\tconst [auth] = useAuthUser()\r\n\tconst [user, isUserLoading] = useContext(UserContext)\r\n\tconst stripe = useStripe();\r\n\tconst elements = useElements()\r\n\tconst [isDisabled, setDisable] = useState(true)\r\n\tconst [setProcessing] = useProcessing()\r\n\tconst pop = usePop()\r\n\tconst handleSubmit = async (event) => {\r\n\t\tevent.preventDefault()\r\n\t\tif (!auth) { return }\r\n\t\tif (!stripe) { return }\r\n\t\tif (!elements) { return }\r\n\t\tconst card = elements.getElement(CardElement)\r\n\t\tif (!card) { return }\r\n\r\n\t\tsetProcessing(true)\r\n\r\n\t\ttry {\r\n\t\t\tconst { error, paymentMethod } = await stripe.createPaymentMethod({\r\n\t\t\t\ttype: 'card',\r\n\t\t\t\tcard: card\r\n\t\t\t})\r\n\r\n\t\t\tif (error) {\r\n\t\t\t\tconsole.log(error)\r\n\t\t\t\tsetProcessing(false)\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\r\n\t\t\tif (!paymentMethod) {\r\n\t\t\t\tsetProcessing(false)\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\r\n\t\t\tconst cardMethod = new Commerce.Card(paymentMethod.id)\r\n\t\t\tcardMethod.id = paymentMethod.id\r\n\t\t\tcardMethod.brand = paymentMethod.card!.brand\r\n\t\t\tcardMethod.expMonth = paymentMethod.card!.exp_month\r\n\t\t\tcardMethod.expYear = paymentMethod.card!.exp_year\r\n\t\t\tcardMethod.last4 = paymentMethod.card!.last4\r\n\r\n\t\t\tlet updateData: any = {\r\n\t\t\t\tdefaultCard: cardMethod.convert()\r\n\t\t\t}\r\n\r\n\t\t\tif (user?.customerID) {\r\n\t\t\t\tconst attach = firebase.functions().httpsCallable('v1-stripe-paymentMethod-attach')\r\n\t\t\t\tconst response = await attach({\r\n\t\t\t\t\tpaymentMethodID: paymentMethod.id\r\n\t\t\t\t})\r\n\t\t\t\tconst { error, result } = response.data\r\n\t\t\t\tif (error) {\r\n\t\t\t\t\tconsole.error(error)\r\n\t\t\t\t\tsetProcessing(false)\r\n\t\t\t\t\treturn\r\n\t\t\t\t}\r\n\t\t\t\tif (result) {\r\n\t\t\t\t\tif (callback) {\r\n\t\t\t\t\t\tcallback(result)\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tconsole.log('[APP] attach payment method', result)\r\n\t\t\t} else {\r\n\t\t\t\tconst create = firebase.functions().httpsCallable('v1-stripe-customer-create')\r\n\t\t\t\tconst response = await create({\r\n\t\t\t\t\tpayment_method: paymentMethod.id,\r\n\t\t\t\t\tphone: auth.phoneNumber,\r\n\t\t\t\t\tinvoice_settings: {\r\n\t\t\t\t\t\tdefault_payment_method: paymentMethod.id\r\n\t\t\t\t\t},\r\n\t\t\t\t\tmetadata: {\r\n\t\t\t\t\t\tuid: auth.uid\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\tconst { error, result } = response.data\r\n\r\n\t\t\t\tif (error) {\r\n\t\t\t\t\tconsole.error(error)\r\n\t\t\t\t\tsetProcessing(false)\r\n\t\t\t\t\treturn\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconsole.log('[APP] create customer', result)\r\n\t\t\t\tif (result) {\r\n\t\t\t\t\tconst customerID = result.id\r\n\t\t\t\t\tupdateData['customerID'] = customerID\r\n\t\t\t\t\tif (callback) {\r\n\t\t\t\t\t\tcallback(result)\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tawait new Commerce.User(auth.uid).documentReference.set(updateData, { merge: true })\r\n\t\t\tsetProcessing(false)\r\n\t\t\tpop()\r\n\t\t} catch (error) {\r\n\t\t\tsetProcessing(false)\r\n\t\t\tconsole.log(error)\r\n\t\t}\r\n\t};\r\n\r\n\tif (isUserLoading) {\r\n\t\treturn <Loading />\r\n\t} else {\r\n\t\treturn (\r\n\t\t\t<Paper>\r\n\t\t\t\t<AppBar position='static' color='transparent' elevation={0}>\r\n\t\t\t\t\t<Toolbar disableGutters>\r\n\t\t\t\t\t\t<Tooltip title='Back' onClick={() => {\r\n\t\t\t\t\t\t\tpop()\r\n\t\t\t\t\t\t}}>\r\n\t\t\t\t\t\t\t<IconButton>\r\n\t\t\t\t\t\t\t\t<ArrowBackIcon color='inherit' />\r\n\t\t\t\t\t\t\t</IconButton>\r\n\t\t\t\t\t\t</Tooltip>\r\n\t\t\t\t\t\t<Box fontSize={18} fontWeight={600}>\r\n\t\t\t\t\t\t\tCard\r\n\t\t\t\t\t\t</Box>\r\n\t\t\t\t\t</Toolbar>\r\n\t\t\t\t</AppBar>\r\n\t\t\t\t<Box p={2}>\r\n\t\t\t\t\t<form>\r\n\t\t\t\t\t\t<CardElement\r\n\t\t\t\t\t\t\toptions={CARD_OPTIONS}\r\n\t\t\t\t\t\t\tonChange={(e) => {\r\n\t\t\t\t\t\t\t\tsetDisable(!e.complete)\r\n\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t<Button className={classes.button}\r\n\t\t\t\t\t\t\tvariant=\"contained\"\r\n\t\t\t\t\t\t\tcolor=\"primary\"\r\n\t\t\t\t\t\t\tsize=\"large\"\r\n\t\t\t\t\t\t\tdisabled={isDisabled}\r\n\t\t\t\t\t\t\tonClick={handleSubmit}>Continue to Payment</Button>\r\n\t\t\t\t\t</form>\r\n\t\t\t\t</Box>\r\n\t\t\t</Paper>\r\n\t\t)\r\n\t}\r\n}\r\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}